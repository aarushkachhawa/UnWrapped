{% extends "base.html" %}

{% block content %}
<body>
    <div class="container">
        {% if error %}
            <p class="error">{{ error }}</p>
        {% else %}
            <h2>Guess the Songs</h2>
            {% if correct_songs|length == 2 %}
                <p>Listen to the track and choose the <strong>two</strong> songs that are mashed together:</p>
            {% elif correct_songs|length == 3 %}
                <p>Listen to the track and choose the <strong>three</strong> songs that are mashed together:</p>
            {% endif %}

            <div class="audio-section">
                <audio controls>
                    <source src="data:audio/wav;base64,{{ mixed_audio }}" type="audio/wav">
                    Your browser does not support the audio element.
                </audio>
            </div>

            <div class="choices" id="choices">
                {% for song in song_choices %}
                    <button data-song="{{ song }}">{{ song }}</button>
                {% endfor %}
            </div>

            <button class="submit-btn" id="submit">Submit</button>
            <button class="reset-btn" id="reset">Reset</button>
            <button class="continue-btn" id="continue" onclick="location.href='{% url 'game2' %}'">Play with 3 Songs</button>
            <button class="back-btn" id="back" onclick="location.href='{% url 'game' %}'">Play with 2 Songs</button>
            <div class="message" id="message"></div>
        {% endif %}
    </div>

{% block extra_style %}
<style>

    body {
        background-repeat: no-repeat;
        background-size: cover;
        background-position: center top 100px;
        background-color: #FCF8F1;
        overflow: hidden;
    }

    h2 {
        margin-bottom: 10px;
    }

    strong {
        color: #c4b3ff;
    }

    .container {
        margin-top: 40px;
    }

    .audio-section {
        margin-top: 30px;
    }

    .choices {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        margin-top: 30px;
    }

    .choices button {
        padding: 10px;
        border: none;
        border-radius: 5px;
        background-color: #C0C0C0;
        color: #FCF8F1;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s, transform 0.2s ease-in-out;
        width: 275px;
        height: 100px;
        font-size: 16px;
        font-family: 'Notable', sans-serif;
    }

    .choices button:hover {
        transform: translateY(-5px);
        background-color: #B0B0B0;
    }

    .submit-btn,
    .reset-btn,
    .continue-btn,
    .back-btn {
        margin-top: 10px;
    }

    .continue-btn,
    .back-btn {
        display: none;
    }

    .message {
        margin-top: 10px;
    }

    .choices button.selected {
        background-color: #6c757d;
    }

    .choices button.correct {
        background-color: #28a745;
    }

    .choices button.incorrect {
        background-color: #dc3545;
    }

    .submit-btn {
        background-color: #5AABF3;
        margin-top: 20px;
    }

    .reset-btn {
        background-color: #EF6E53;
    }

    .submit-btn, .reset-btn, .continue-btn, .back-btn{
        color: white;
        width: 200px;
        height: 30px;
        border-radius: 5px;
        border: none;
    }

    .continue-btn {
        background-color: #c4b3ff;
        color: white;
        position: absolute;
        left: calc(50% + 130px);
        top: 628px
    }

    .back-btn {
        background-color: #c4b3ff;
        color: white;
        position: absolute;
        left: calc(50% + 130px);
        top: 738px
    }

    .submit-btn:hover {
        background-color: #3d90d9;
    }

    .reset-btn:hover {
        background-color: #cf5138;
    }

    .continue-btn:hover {
        background-color: #b4a6de;
    }

    .back-btn:hover {
        background-color: #b4a6de;
    }
</style>
{% endblock %}

<script>
    {% if not error %}
    const correctSongs = {{ correct_songs|safe }};
    let selectedSongs = [];
    const maxSelections = correctSongs.length;

    document.querySelectorAll('#choices button').forEach(button => {
    button.addEventListener('click', () => {
        const song = button.getAttribute('data-song');

        if (selectedSongs.includes(song)) {
            // Deselect the song
            selectedSongs = selectedSongs.filter(s => s !== song);
            button.classList.remove('selected');
        } else {
            if (selectedSongs.length === maxSelections) {
                // Deselect the first selected song to make room for the new one
                const firstSelected = selectedSongs.shift();
                const firstButton = document.querySelector(`button[data-song="${firstSelected}"]`);
                if (firstButton) firstButton.classList.remove('selected');
            }
            // Select the new song
            selectedSongs.push(song);
            button.classList.add('selected');
        }
    });
    });

    document.getElementById('submit').addEventListener('click', () => {
    const messageElement = document.getElementById('message');
    if (selectedSongs.length !== maxSelections) {
        messageElement.textContent = `Please select exactly ${maxSelections} song${maxSelections > 1 ? 's' : ''}.`;
        messageElement.style.color = 'orange';
        return;
    }

    const correctCount = selectedSongs.filter(song => correctSongs.includes(song)).length;
    if (correctCount === maxSelections) {
        messageElement.textContent = `${maxSelections}/${maxSelections} correct! Well done!`;
        messageElement.style.color = 'green';
        highlightCorrect();
        {% if correct_songs|length == 2 %}
            document.getElementById('continue').style.display = 'inline-block';
        {% elif correct_songs|length == 3 %}
            document.getElementById('back').style.display = 'inline-block';
        {% endif %}
    } else {
        messageElement.textContent = `${correctCount}/${maxSelections} correct`;
        messageElement.style.color = correctCount > 0 ? 'orange' : 'red';
        highlightIncorrect();
    }
    });

    document.getElementById('reset').addEventListener('click', () => {
    window.location.reload();
    });

    function highlightIncorrect() {
    document.querySelectorAll('#choices button').forEach(button => {
        const song = button.getAttribute('data-song');
        if (!correctSongs.includes(song) && selectedSongs.includes(song)) {
            button.classList.add('incorrect');
        }
        if (correctSongs.includes(song)) {
            button.classList.add('correct');
        }
        button.disabled = true;
    });
    }

    function highlightCorrect() {
    document.querySelectorAll('#choices button').forEach(button => {
        const song = button.getAttribute('data-song');
        if (correctSongs.includes(song)) {
            button.classList.add('correct');
        }
        button.disabled = true;
    });
    }
    {% endif %}
</script>

</body>
{% endblock %}
